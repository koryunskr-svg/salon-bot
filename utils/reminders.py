# utils/reminders.py
import logging  # <-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç logging
from datetime import datetime, timedelta
# import pytz # <-- –£–±—Ä–∞–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç (TIMEZONE –±–µ—Ä—ë—Ç—Å—è –∏–∑ config)
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from config import TIMEZONE, SHEET_ID, CALENDAR_ID # <-- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç CALENDAR_ID
# <-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç safe_delete_calendar_event
from .safe_google import safe_get_sheet_data, safe_update_sheet_row, safe_delete_calendar_event
from .admin import notify_admins
# <-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç get_setting
from .settings import get_setting

logger = logging.getLogger(__name__) # <-- –¢–µ–ø–µ—Ä—å —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

async def send_reminders(context):
    """
    –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 24—á –∏ 1—á.
    –û–∂–∏–¥–∞–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏—Å—Ç–∞ "–ó–∞–ø–∏—Å–∏": 
    A2:P -> ID, –ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∑–≤–∞–Ω–∏–µ, –ú–∞—Å—Ç–µ—Ä, –î–∞—Ç–∞, –í—Ä–µ–º—è, –°—Ç–∞—Ç—É—Å, 
            –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 24—á, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 1—á, chat_id, event_id
    """
    now = datetime.now(TIMEZONE)
    logger.debug("üîÑ –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π...")
    # A2:P -> ID, –ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∑–≤–∞–Ω–∏–µ, –ú–∞—Å—Ç–µ—Ä, –î–∞—Ç–∞, –í—Ä–µ–º—è, –°—Ç–∞—Ç—É—Å, –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 24—á, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 1—á, chat_id, event_id
    records = safe_get_sheet_data(SHEET_ID, "–ó–∞–ø–∏—Å–∏!A2:P")

    for i, row in enumerate(records, start=2): # start=2, –ø–æ—Ç–æ–º—É —á—Ç–æ A2:P
        if len(row) < 15 or row[8] != "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ": # [8] = –°—Ç–∞—Ç—É—Å
            continue

        record_id = row[0] # [0] = ID
        name = row[1] # [1] = –ò–º—è
        phone = row[2] # [2] = –¢–µ–ª–µ—Ñ–æ–Ω
        # category = row[3] # [3] = –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è)
        # sub_service = row[4] # [4] = –ù–∞–∑–≤–∞–Ω–∏–µ (–ø–æ–¥—É—Å–ª—É–≥–∞)
        # master = row[5] # [5] = –ú–∞—Å—Ç–µ—Ä
        date_str = row[6] # [6] = –î–∞—Ç–∞
        time_str = row[7] # [7] = –í—Ä–µ–º—è
        chat_id = row[13] # [13] = chat_id

        try:
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –≤ –æ–±—ä–µ–∫—Ç datetime
            event_time = datetime.strptime(f"{date_str} {time_str}", "%d.%m.%Y %H:%M")
            # –õ–æ–∫–∞–ª–∏–∑—É–µ–º –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –±–æ—Ç–∞
            event_time = TIMEZONE.localize(event_time)
        except ValueError:
            logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–ø–∏—Å–∏ {record_id}: {date_str} {time_str}")
            continue

        # --- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 24 —á–∞—Å–∞ ---
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ª–∏ –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 24 —á–∞—Å–∞ (—Å —Ç–æ—á–Ω–æ—Å—Ç—å—é +/- 5 –º–∏–Ω—É—Ç)
        if abs((event_time - now).total_seconds() - 24*3600) < 300 and row[11] == "‚ùå": # [11] = –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 24—á
            try:
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                message_text = get_setting(
                    "–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è 24—á", 
                    f"–ù–∞–ø–æ–º–∏–Ω–∞–µ–º: –∑–∞–≤—Ç—Ä–∞ —É –≤–∞—Å –∑–∞–ø–∏—Å—å –Ω–∞ {{row[4]}} –∫ {{row[5]}} –≤ {{time_str}}."
                ).format(row=row, time_str=time_str) # –ò—Å–ø–æ–ª—å–∑—É–µ–º .format –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
                await context.bot.send_message(
                    chat_id=chat_id,
                    text=message_text,
                    reply_markup=build_confirm_cancel_kb(record_id) # –°–º. –Ω–∏–∂–µ
                )
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è 24—á –Ω–∞ "‚úÖ"
                updated_row = row.copy()
                updated_row[11] = "‚úÖ"
                safe_update_sheet_row(SHEET_ID, "–ó–∞–ø–∏—Å–∏", i, updated_row)
                logger.info(f"üì§ 24—á –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {name} (ID: {record_id})")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ 24—á –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {record_id}: {e}")
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                admin_message = get_setting(
                    "–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ–± –æ—à–∏–±–∫–µ", 
                    f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É {{name}}. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ: {{phone}}. –û—à–∏–±–∫–∞: {{e}}"
                ).format(name=name, phone=phone, e=e) # –ò—Å–ø–æ–ª—å–∑—É–µ–º .format –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
                await notify_admins(context, admin_message)

        # --- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 —á–∞—Å ---
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ª–∏ –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 1 —á–∞—Å (—Å —Ç–æ—á–Ω–æ—Å—Ç—å—é +/- 5 –º–∏–Ω—É—Ç)
        if abs((event_time - now).total_seconds() - 3600) < 300 and row[12] == "‚ùå": # [12] = –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 1—á
            try:
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                message_text = get_setting(
                    "–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è 1—á", 
                    f"–ß–µ—Ä–µ–∑ —á–∞—Å —É –≤–∞—Å –ø—Ä–∏—ë–º. –ù–µ –æ–ø–∞–∑–¥—ã–≤–∞–π—Ç–µ!"
                )
                await context.bot.send_message(chat_id=chat_id, text=message_text)
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è 1—á –Ω–∞ "‚úÖ"
                updated_row = row.copy()
                updated_row[12] = "‚úÖ"
                safe_update_sheet_row(SHEET_ID, "–ó–∞–ø–∏—Å–∏", i, updated_row)
                logger.info(f"üì§ 1—á –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {name} (ID: {record_id})")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ 1—á –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {record_id}: {e}")
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                admin_message = get_setting(
                    "–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ–± –æ—à–∏–±–∫–µ 1—á", # <-- –£—Ç–æ—á–Ω—ë–Ω –∫–ª—é—á –¥–ª—è 1—á
                    f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 1—á –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É {{name}}. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ: {{phone}}. –û—à–∏–±–∫–∞: {{e}}"
                ).format(name=name, phone=phone, e=e) # –ò—Å–ø–æ–ª—å–∑—É–µ–º .format –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
                await notify_admins(context, admin_message)
    logger.debug("‚úÖ –ó–∞–¥–∞—á–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

def build_confirm_cancel_kb(record_id: str):
    """–°–æ–∑–¥–∞—ë—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è 24—á –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è."""
    keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é", callback_data=f"confirm_reminder_{record_id}")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω—è—é", callback_data=f"cancel_reminder_{record_id}")]
    ]
    return InlineKeyboardMarkup(keyboard)

async def handle_confirm_reminder(record_id: str, query, context):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é' –≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏.
    """
    logger.info(f"üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ {record_id}")
    try:
        # A2:P -> ID, –ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∑–≤–∞–Ω–∏–µ, –ú–∞—Å—Ç–µ—Ä, –î–∞—Ç–∞, –í—Ä–µ–º—è, –°—Ç–∞—Ç—É—Å, –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 24—á, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 1—á, chat_id, event_id
        records = safe_get_sheet_data(SHEET_ID, "–ó–∞–ø–∏—Å–∏!A2:P")
        for idx, row in enumerate(records, start=2): # start=2, –ø–æ—Ç–æ–º—É —á—Ç–æ A2:P
            if len(row) > 0 and row[0] == record_id:
                logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å {record_id} –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.")
                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤ —Å—Ç—Ä–æ–∫–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–ª–æ–Ω–æ–∫
                # if len(row) < 12: # <-- –ù–µ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
                #     row.extend([""] * (12 - len(row))) # –†–∞—Å—à–∏—Ä—è–µ–º —Å—Ç—Ä–æ–∫—É –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è 24—á
                current_reminder_status = row[11] if len(row) > 11 else "‚ùå" # [11] = –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 24—á
                
                if current_reminder_status == "‚ùå":
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è 24—á –Ω–∞ "‚úÖ"
                    # row[11] = "‚úÖ" # <-- –ù–µ –∏–∑–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
                    updated_values = row.copy()
                    updated_values[11] = "‚úÖ"
                    safe_update_sheet_row(SHEET_ID, "–ó–∞–ø–∏—Å–∏", idx, updated_values)
                    await query.edit_message_text("‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.")
                    logger.info(f"‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–ø–∏—Å—å {record_id}")
                else:
                    await query.edit_message_text("‚ÑπÔ∏è –í–∞—à –æ—Ç–≤–µ—Ç —É–∂–µ –±—ã–ª —É—á—Ç—ë–Ω.")
                    logger.info(f"‚ÑπÔ∏è –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ {record_id} –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞.")
                return # <-- –í–∞–∂–Ω–æ: –≤—ã–π—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        # –ï—Å–ª–∏ —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –∑–Ω–∞—á–∏—Ç –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        await query.edit_message_text("‚ùå –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        logger.warning(f"‚ö†Ô∏è –ó–∞–ø–∏—Å—å {record_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.")
    except Exception as e:
        logger.exception(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {record_id}: {e}")
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
        try:
            await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª—ë–Ω.")
        except:
             pass # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
        await notify_admins(context, f"üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {record_id}: {e}")

async def handle_cancel_reminder(record_id: str, query, context):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ '–û—Ç–º–µ–Ω—è—é' –≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏.
    """
    logger.info(f"üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É –∑–∞–ø–∏—Å–∏ {record_id} –∏–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.")
    try:
        # A2:P -> ID, –ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∑–≤–∞–Ω–∏–µ, –ú–∞—Å—Ç–µ—Ä, –î–∞—Ç–∞, –í—Ä–µ–º—è, –°—Ç–∞—Ç—É—Å, –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 24—á, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ 1—á, chat_id, event_id
        records = safe_get_sheet_data(SHEET_ID, "–ó–∞–ø–∏—Å–∏!A2:P")
        for idx, row in enumerate(records, start=2): # start=2, –ø–æ—Ç–æ–º—É —á—Ç–æ A2:P
            if len(row) > 0 and row[0] == record_id:
                 logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å {record_id} –¥–ª—è –æ—Ç–º–µ–Ω—ã.")
                 # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤ —Å—Ç—Ä–æ–∫–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–ª–æ–Ω–æ–∫
                 # if len(row) < 9: # <-- –ù–µ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
                 #     row.extend([""] * (9 - len(row))) # –†–∞—Å—à–∏—Ä—è–µ–º —Å—Ç—Ä–æ–∫—É –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                 
                 # –ü–æ–ª—É—á–∞–µ–º event_id –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
                 event_id = row[14] if len(row) > 14 else None # [14] = event_id
                 chat_id = row[13] if len(row) > 13 else None # [13] = chat_id
                 name = row[1] if len(row) > 1 else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" # [1] = –ò–º—è
                 phone = row[2] if len(row) > 2 else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" # [2] = –¢–µ–ª–µ—Ñ–æ–Ω
                 
                 # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ –Ω–∞ "–æ—Ç–º–µ–Ω–µ–Ω–æ"
                 # row[8] = "–æ—Ç–º–µ–Ω–µ–Ω–æ" # [8] = –°—Ç–∞—Ç—É—Å # <-- –ù–µ –∏–∑–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
                 updated_values = row.copy()
                 updated_values[8] = "–æ—Ç–º–µ–Ω–µ–Ω–æ" # [8] = –°—Ç–∞—Ç—É—Å
                 safe_update_sheet_row(SHEET_ID, "–ó–∞–ø–∏—Å–∏", idx, updated_values)

                 # –£–¥–∞–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                 if event_id:
                     # <-- safe_delete_calendar_event –¢–ï–ü–ï–†–¨ –ò–ú–ü–û–†–¢–ò–†–û–í–ê–ù–ê
                     safe_delete_calendar_event(CALENDAR_ID, event_id) # <-- NameError –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
                     logger.info(f"Ï∫ò –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ {event_id} —É–¥–∞–ª–µ–Ω–æ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏ {record_id}")

                 await query.edit_message_text("‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Å–æ–æ–±—â–∏–ª–∏.")
                 logger.info(f"‚ùå –ö–ª–∏–µ–Ω—Ç –æ—Ç–º–µ–Ω–∏–ª –∑–∞–ø–∏—Å—å {record_id}")

                 # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
                 # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                 admin_message = get_setting(
                     "–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ–± –æ—Ç–º–µ–Ω–µ –∏–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", # <-- –£—Ç–æ—á–Ω—ë–Ω –∫–ª—é—á
                     f"‚ùó –ö–ª–∏–µ–Ω—Ç –æ—Ç–º–µ–Ω–∏–ª –∑–∞–ø–∏—Å—å {{record_id}}. –ò–º—è: {{name}}, –¢–µ–ª–µ—Ñ–æ–Ω: {{phone}}."
                 ).format(record_id=record_id, name=name, phone=phone) # –ò—Å–ø–æ–ª—å–∑—É–µ–º .format –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
                 await notify_admins(context, admin_message)
                 return # <-- –í–∞–∂–Ω–æ: –≤—ã–π—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        # –ï—Å–ª–∏ —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –∑–Ω–∞—á–∏—Ç –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        await query.edit_message_text("‚ùå –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        logger.warning(f"‚ö†Ô∏è –ó–∞–ø–∏—Å—å {record_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–º–µ–Ω—ã –∏–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.")
    except Exception as e:
        logger.exception(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {record_id}: {e}")
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
        try:
             await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–º–µ–Ω—ã. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª—ë–Ω.")
        except:
             pass # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
        await notify_admins(context, f"üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏ {record_id} –∏–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ò—Å–ø–æ–ª—å–∑—É–µ–º logger.info –≤–º–µ—Å—Ç–æ print
logger.info("‚úÖ –ú–æ–¥—É–ª—å reminders.py –∑–∞–≥—Ä—É–∂–µ–Ω.")
